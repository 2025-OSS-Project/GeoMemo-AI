# .github/workflows/discord-notify.yml
name: ğŸ“¨ Discord Issue & PR ì•Œë¦¼ (ì„ë² ë“œ/ì•ˆì „íŒ)

on:
  workflow_dispatch: {}
  issues:
    types: [opened, closed, reopened, edited]
  pull_request:
    types: [opened, closed, reopened, synchronize, edited]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # 1) ë ˆí¬ë³„ ì›¹í›… ì„ íƒ + í¬í¬/ì‹œí¬ë¦¿ ë¯¸ì œê³µ ì•ˆì „ì¥ì¹˜
      - name: Select Discord webhook
        id: hook
        shell: bash
        run: |
          REPO="${{ github.repository }}"
          case "$REPO" in
            2025-OSS-Project/GeoMemo-Backend)  URL="${{ secrets.WEBHOOK_BACKEND }}"  ;;
            2025-OSS-Project/GeoMemo-Frontend) URL="${{ secrets.WEBHOOK_FRONTEND }}" ;;
            2025-OSS-Project/GeoMemo-AI)       URL="${{ secrets.WEBHOOK_AI }}"       ;;
            *) echo "::error::Unknown repository: $REPO"; exit 1 ;;
          esac

          # í¬í¬ PRì´ë©´ secrets ë¯¸ì œê³µ â†’ URLì´ ë¹„ì–´ ìˆì„ ìˆ˜ ìˆìŒ
          if [ -z "$URL" ]; then
            echo "has_webhook=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing_secret_or_fork_pr" >> "$GITHUB_OUTPUT"
          else
            echo "has_webhook=true" >> "$GITHUB_OUTPUT"
            echo "url=$URL" >> "$GITHUB_OUTPUT"
          fi

          echo "is_fork=${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork }}" >> "$GITHUB_OUTPUT"

      - name: Skip when secrets are unavailable (e.g., fork PR)
        if: steps.hook.outputs.has_webhook != 'true'
        run: |
          echo "â„¹ï¸ No webhook available (fork PR or secret missing). Skipping notification."
          echo "Reason: ${{ steps.hook.outputs.reason }}"
          echo "is_fork: ${{ steps.hook.outputs.is_fork }}"

      # 2-A) Issue ì„ë² ë“œ
      - name: Compute Issue embed color
        id: issue
        if: steps.hook.outputs.has_webhook == 'true' && github.event_name == 'issues'
        run: |
          case "${{ github.event.action }}" in
            opened|reopened) COLOR=0x00B0F4 ;;   # íŒŒë‘
            closed)          COLOR=0x808080 ;;   # íšŒìƒ‰
            *)               COLOR=0xF4D742 ;;   # ë…¸ë‘
          esac
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Send Issue embed
        if: steps.hook.outputs.has_webhook == 'true' && github.event_name == 'issues'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ steps.hook.outputs.url }}
          username: "Issue Bot ğŸ›"
          color: ${{ steps.issue.outputs.color }}
          title: "ğŸ› Issue #${{ github.event.issue.number }} ${{ github.event.action }}"
          url: ${{ github.event.issue.html_url }}
          description: |
            **${{ github.event.issue.title }}**
            ì‘ì„±ì: @${{ github.event.issue.user.login }}

      # 2-B) PR ì„ë² ë“œ
      - name: Compute PR embed color
        id: pr
        if: steps.hook.outputs.has_webhook == 'true' && github.event_name == 'pull_request'
        run: |
          if   [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            COLOR=0x57F287   # ì´ˆë¡(ë¨¸ì§€)
          elif [ "${{ github.event.action }}" = "opened" ] || [ "${{ github.event.action }}" = "reopened" ]; then
            COLOR=0xF47FFF   # ë³´ë¼(ì‹ ê·œ/ì¬ì˜¤í”ˆ)
          else
            COLOR=0xFAA61A   # ì£¼í™©(ë™ê¸°í™”/ìˆ˜ì • ë“±)
          fi
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Send PR embed
        if: steps.hook.outputs.has_webhook == 'true' && github.event_name == 'pull_request'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ steps.hook.outputs.url }}
          username: "PR Bot ğŸš€"
          color: ${{ steps.pr.outputs.color }}
          title: "ğŸš€ PR #${{ github.event.pull_request.number }} ${{ github.event.action }}"
          url: ${{ github.event.pull_request.html_url }}
          description: |
            **${{ github.event.pull_request.title }}**
            ì‘ì„±ì: @${{ github.event.pull_request.user.login }}
            ë¸Œëœì¹˜: `${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}`
